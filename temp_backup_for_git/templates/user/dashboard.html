{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="font-playfair">My Wedding Plans</h2>
        <span class="badge bg-gold text-dark p-2">Welcome, {{ session.username }}</span>
    </div>

    <div class="row">
        <div class="col-12">

            <!-- Quick Action -->
            <div class="text-end mb-3">
                <a href="{{ url_for('index') }}" class="btn btn-dark">
                    <i class="bi bi-plus-lg"></i> Book New Service
                </a>
            </div>

            <!-- Bookings List -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gold text-dark">
                    <h5 class="mb-0">My Bookings</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Service</th>
                                    <th>Destination</th>
                                    <th>Hours</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="custBookingList">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Loading your bookings...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Pay for Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <input type="hidden" id="payBookingId">
                    <div class="mb-3">
                        <label class="form-label">Cardholder Name</label>
                        <input type="text" class="form-control" required placeholder="Name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Card Number</label>
                        <input type="text" class="form-control" required placeholder="0000 0000 0000 0000">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Expiry</label>
                            <input type="text" class="form-control" required placeholder="MM/YY">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">CVV</label>
                            <input type="text" class="form-control" required placeholder="123">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Pay Now</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', loadMyBookings);

    async function loadMyBookings() {
        try {
            const resp = await fetch('/api/bookings');
            const bookings = await resp.json();

            const tbody = document.getElementById('custBookingList');
            if (bookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No bookings yet. <a href="{{ url_for("index") }}">Start Planning!</a></td></tr>';
                return;
            }

            tbody.innerHTML = bookings.map(b => `
                <tr>
                    <td>${b.booking_date}<br><small class="text-muted">${b.start_time}</small></td>
                    <td><strong>${b.category_name}</strong></td>
                    <td>${b.destination_name}</td>
                    <td>${b.hours} hrs</td>
                    <td>â‚¬${b.total_price.toFixed(2)}</td>
                    <td><span class="badge ${getStatusClass(b.status)}">${b.status}</span></td>
                    <td>
                        ${b.status === 'accepted' ?
                    `<button class="btn btn-sm btn-success" onclick="openPayment(${b.id})">Pay Now</button>` :
                    '-'}
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            console.error(e);
        }
    }

    function getStatusClass(status) {
        if (status === 'pending') return 'bg-warning text-dark';
        if (status === 'accepted') return 'bg-info text-dark';
        if (status === 'paid') return 'bg-success';
        return 'bg-secondary';
    }

    // Payment Logic
    let payModal;
    function openPayment(id) {
        if (!payModal) payModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        document.getElementById('payBookingId').value = id;
        payModal.show();
    }

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('payBookingId').value;
        const resp = await fetch(`/api/bookings/${id}/pay`, { method: 'POST' });
        if (resp.ok) {
            alert('Payment Successful!');
            payModal.hide();
            loadMyBookings();
        } else {
            alert('Payment failed.');
        }
    });
</script>
{% endblock %}